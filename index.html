<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layanan Informasi Cuti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        #cropOverlay {
            pointer-events: all;
            user-select: none;
        }
        #photoCanvas {
            cursor: grab;
        }
        #photoCanvas:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-red-600 via-red-700 to-red-800 shadow-2xl">
        <div class="container mx-auto px-6 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-red-600 font-bold text-2xl">📻</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Procuti RRI Sibolga</h1>
                        <p class="text-red-100">Sistem Manajemen Cuti Pegawai Radio Republik Indonesia</p>
                        <div class="flex items-center space-x-4 mt-2">
                            <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                <span class="text-white text-sm font-medium">📊 Total Pegawai: <span id="totalEmployees">0</span></span>
                            </div>
                            <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                <span class="text-white text-sm font-medium">🏆 Cuti Terbanyak: <span id="mostUsedLeave">-</span></span>
                            </div>
                            <button onclick="loadEmployeesFromFirestore()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded-full transition-colors">
                                <span class="text-white text-sm font-medium">🔄 Refresh Data</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-red-100">Mode:</span>
                        <button id="modeToggle" class="bg-white text-red-600 px-4 py-2 rounded-lg hover:bg-red-50 transition-colors font-medium">
                            👤 Pengguna
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Admin Controls -->
        <div id="adminControls" class="hidden mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    ⚙️ Panel Admin
                </h2>
                <button id="addEmployeeBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    ➕ Tambah Pegawai Baru
                </button>
            </div>
        </div>

        <!-- Pegawai Cuti Hari Ini -->
        <div class="mb-8">
            <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <span class="text-2xl">🏖️</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Pegawai Cuti Hari Ini</h2>
                            <p class="text-orange-100" id="todayDate">Loading...</p>
                        </div>
                    </div>
                    <button id="refreshCutiData" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors">
                        🔄 Refresh
                    </button>
                </div>
                
                <div id="cutiTodayContainer" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                        <span class="ml-3">Memuat data cuti...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Search Bar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 h-full">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            🔍 Pencarian
                        </h3>
                        <div class="flex flex-col space-y-3">
                            <input type="text" id="searchInput" placeholder="Cari nama pegawai..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                🔍 Cari Pegawai
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Ajukan Cuti -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 h-full">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            📝 Ajukan Cuti
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">Buat permohonan cuti online</p>
                        <a href="https://forms.gle/861qeHyM5Puou9Ue9" target="_blank" rel="noopener noreferrer" 
                           class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium text-center block">
                            📋 Formulir Cuti
                        </a>
                    </div>
                </div>
                
                <!-- Unduh Berkas -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 h-full">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            📁 Unduh Berkas
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">Akses folder berkas persyaratan cuti</p>
                        <a href="GANTI_DENGAN_URL_GOOGLE_DRIVE_ANDA" target="_blank" rel="noopener noreferrer" 
                           class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium text-center block">
                            📄 Folder Google Drive
                        </a>
                    </div>
                </div>
                

            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-16">
            <div class="flex items-center justify-center mb-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
            </div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Memuat Data Pegawai...</h3>
            <p class="text-gray-500">Mohon tunggu sebentar</p>
        </div>

        <!-- Employee Cards Grid -->
        <div id="employeeGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Employee cards will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <div class="text-6xl mb-4">📄</div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Belum Ada Data Pegawai</h3>
            <p class="text-gray-500">Login sebagai admin untuk menambahkan data pegawai</p>
        </div>
    </main>

    <!-- Employee Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Detail Cuti Pegawai</h2>
                        <button id="closeDetailModal" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                    </div>
                    
                    <div id="detailContent">
                        <!-- Detail content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white font-bold text-2xl">🔐</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Login Admin</h2>
                        <p class="text-gray-600">Masukkan kredensial admin untuk melanjutkan</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="adminEmail" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                   placeholder="Masukkan email admin">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="adminPassword" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                   placeholder="Masukkan password">
                        </div>
                        
                        <div id="loginError" class="hidden text-red-500 text-sm text-center"></div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                                🔓 Login
                            </button>
                            <button type="button" id="cancelLogin" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Narasi Cuti Modal -->
    <div id="narasiModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="narasiModalTitle" class="text-xl font-bold text-gray-800">Edit Narasi Cuti</h2>
                        <button id="closeNarasiModal" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                    </div>
                    
                    <form id="narasiForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" id="narasiLabel">Narasi untuk Cuti</label>
                            <textarea id="narasiText" rows="4" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                      placeholder="Masukkan narasi atau keterangan untuk jenis cuti ini..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">Narasi ini akan ditampilkan ketika detail cuti diklik</p>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                💾 Simpan Narasi
                            </button>
                            <button type="button" id="cancelNarasiModal" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="modalTitle" class="text-xl font-bold text-gray-800">Tambah Pegawai Baru</h2>
                        <button id="closeEmployeeModal" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                    </div>
                    
                    <form id="employeeForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pegawai</label>
                            <input type="text" id="employeeName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                            <input type="text" id="employeeNip" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jabatan</label>
                            <input type="text" id="employeePosition" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto Pegawai (Maksimal 700KB)</label>
                            <div class="flex items-center space-x-4">
                                <div id="photoPreview" class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden">
                                    <span class="text-gray-500 text-xs">Foto</span>
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="employeePhoto" accept="image/*" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG, GIF. Maksimal 700KB</p>
                                </div>
                            </div>
                            <div id="photoError" class="hidden text-red-500 text-sm mt-2"></div>
                            
                            <!-- Photo Editor -->
                            <div id="photoEditor" class="hidden mt-4 p-4 border border-gray-300 rounded-lg bg-gray-50">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">✂️ Edit Posisi Foto</h4>
                                <div class="flex flex-col items-center space-y-3">
                                    <div class="relative">
                                        <canvas id="photoCanvas" class="border border-gray-300 rounded-lg max-w-full" width="300" height="300"></canvas>
                                        <div id="cropOverlay" class="absolute border-2 border-blue-500 bg-blue-500 bg-opacity-20 rounded-full cursor-move" 
                                             style="width: 150px; height: 150px; top: 75px; left: 75px;"></div>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-2 justify-center">
                                        <button type="button" id="zoomIn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">🔍+ Zoom In</button>
                                        <button type="button" id="zoomOut" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">🔍- Zoom Out</button>
                                        <button type="button" id="rotateLeft" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">↺ Putar Kiri</button>
                                        <button type="button" id="rotateRight" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">↻ Putar Kanan</button>
                                        <button type="button" id="resetPhoto" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">🔄 Reset</button>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button type="button" id="applyPhotoEdit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">✅ Terapkan</button>
                                        <button type="button" id="cancelPhotoEdit" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">❌ Batal</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">📊 Data Cuti Pegawai</h3>
                                <button type="button" id="scrollToCuti" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg hover:bg-blue-200 transition-colors text-sm">
                                    ⬇️ Gulir ke Data Cuti
                                </button>
                            </div>
                        </div>
                        
                        <div id="cutiSection" class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cuti Tahunan</label>
                                <input type="number" id="cutiTahunan" min="0" value="0" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cuti Besar</label>
                                <input type="number" id="cutiBesar" min="0" value="0" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cuti Alasan Penting</label>
                                <input type="number" id="cutiAlasanPenting" min="0" value="0" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cuti Sakit</label>
                                <input type="number" id="cutiSakit" min="0" value="0" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cuti Melahirkan</label>
                                <input type="number" id="cutiMelahirkan" min="0" value="0" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cuti Diluar Tanggungan</label>
                                <input type="number" id="cutiDiluarTanggungan" min="0" value="0" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Simpan
                            </button>
                            <button type="button" id="cancelEmployeeModal" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA2g-S8gqwR9Iatyf24nWEIeVoPxaWXrgs",
            authDomain: "cutiku-proyek3.firebaseapp.com",
            projectId: "cutiku-proyek3",
            storageBucket: "cutiku-proyek3.firebasestorage.app",
            messagingSenderId: "396284262554",
            appId: "1:396284262554:web:08d54fa176885d6d7d0723",
            measurementId: "G-SJTJ6SZNS6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Application State
        let isAdminMode = false;
        let currentUser = null;
        let cutiData = []; // Data cuti dari Google Sheets
        let employees = [];
        let editingEmployeeId = null;
        let currentNarasiEmployee = null;
        let currentNarasiType = null;

        // Photo editor variables
        let photoEditorState = {
            originalImage: null,
            canvas: null,
            ctx: null,
            scale: 1,
            rotation: 0,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            cropX: 75,
            cropY: 75,
            cropSize: 150
        };

        // DOM Elements
        const modeToggle = document.getElementById('modeToggle');
        const adminControls = document.getElementById('adminControls');
        const employeeGrid = document.getElementById('employeeGrid');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const detailModal = document.getElementById('detailModal');
        const employeeModal = document.getElementById('employeeModal');
        const employeeForm = document.getElementById('employeeForm');

        // Firebase Authentication Functions
        function initAuth() {
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                if (user) {
                    console.log('User logged in:', user.email);
                    // Check if user is admin
                    if (user.email === 'priadipasaribu@gmail.com') {
                        isAdminMode = true;
                        modeToggle.textContent = '👨‍💼 Admin';
                        modeToggle.className = 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium';
                        adminControls.classList.remove('hidden');
                    } else {
                        isAdminMode = false;
                        modeToggle.textContent = '👤 ' + user.email.split('@')[0];
                        modeToggle.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium';
                        adminControls.classList.add('hidden');
                    }
                    closeLoginModal();
                } else {
                    console.log('User logged out');
                    isAdminMode = false;
                    modeToggle.textContent = '👤 Login';
                    modeToggle.className = 'bg-white text-red-600 px-4 py-2 rounded-lg hover:bg-red-50 transition-colors font-medium';
                    adminControls.classList.add('hidden');
                }
                renderEmployees();
            });
        }

        // Firebase Firestore Functions
        async function loadEmployeesFromFirestore() {
            try {
                console.log('🔄 Starting to load employees from Firestore...');
                console.log('📊 Firebase config check:', firebase.apps.length > 0 ? 'Firebase initialized' : 'Firebase NOT initialized');
                console.log('🔗 Database connection:', db ? 'Database connected' : 'Database NOT connected');
                
                // Show loading state
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('employeeGrid').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                
                // Test Firebase connection first
                console.log('🧪 Testing Firestore connection...');
                const testQuery = await db.collection('employees').limit(1).get();
                console.log('✅ Firestore connection successful, query returned:', testQuery.size, 'documents');
                
                // Now load all employees
                console.log('📥 Loading all employees...');
                const snapshot = await db.collection('employees').orderBy('name').get();
                
                employees = [];
                console.log('📋 Processing', snapshot.size, 'documents from Firestore...');
                
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    console.log(`📄 Document ${index + 1}:`, doc.id, data);
                    employees.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log('✅ Successfully loaded', employees.length, 'employees from Firestore');
                console.log('👥 Employee list:', employees.map(emp => ({ id: emp.id, name: emp.name })));
                
                // Always render employees, even if array is empty
                renderEmployees();
                updateStatistics();
                
                // Hide loading state
                document.getElementById('loadingState').classList.add('hidden');
                
                // Show success message in console
                console.log('🎉 Data loading completed successfully!');
                
            } catch (error) {
                console.error('❌ Error loading employees:', error);
                console.error('🔍 Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                // Hide loading state even on error
                document.getElementById('loadingState').classList.add('hidden');
                
                // Show detailed error message
                const employeeGrid = document.getElementById('employeeGrid');
                const emptyState = document.getElementById('emptyState');
                
                employeeGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                emptyState.innerHTML = `
                    <div class="text-center py-16">
                        <div class="text-6xl mb-4">⚠️</div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Gagal Memuat Data Pegawai</h3>
                        <p class="text-gray-500 mb-2">Terjadi kesalahan saat memuat data dari database</p>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 max-w-md mx-auto">
                            <p class="text-red-700 text-sm font-medium">Detail Error:</p>
                            <p class="text-red-600 text-xs mt-1">${error.message}</p>
                            ${error.code ? `<p class="text-red-500 text-xs mt-1">Kode: ${error.code}</p>` : ''}
                        </div>
                        <div class="space-y-2">
                            <button onclick="loadEmployeesFromFirestore()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                🔄 Coba Lagi
                            </button>
                            <br>
                            <button onclick="checkFirebaseStatus()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                🔍 Periksa Koneksi Firebase
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        async function saveEmployeeToFirestore(employeeData) {
            try {
                if (employeeData.id && typeof employeeData.id === 'string') {
                    // Update existing employee
                    const { id, ...dataToUpdate } = employeeData;
                    await db.collection('employees').doc(id).update(dataToUpdate);
                    console.log('Employee updated in Firestore');
                } else {
                    // Add new employee
                    const { id, ...dataToAdd } = employeeData;
                    const docRef = await db.collection('employees').add(dataToAdd);
                    console.log('Employee added to Firestore with ID:', docRef.id);
                }
                await loadEmployeesFromFirestore();
            } catch (error) {
                console.error('Error saving employee:', error);
                alert('Gagal menyimpan data pegawai. Silakan coba lagi.');
            }
        }

        async function deleteEmployeeFromFirestore(employeeId) {
            try {
                console.log('Deleting employee from Firestore with ID:', employeeId);
                
                // Check if document exists first
                const docRef = db.collection('employees').doc(employeeId);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    throw new Error('Document does not exist');
                }
                
                // Delete the document
                await docRef.delete();
                console.log('Employee successfully deleted from Firestore');
                
                // Reload employees data
                await loadEmployeesFromFirestore();
                
            } catch (error) {
                console.error('Error deleting employee from Firestore:', error);
                throw error; // Re-throw to be handled by calling function
            }
        }

        // Initialize App
        function init() {
            console.log('Initializing app...');
            updateTodayDate();
            setupEventListeners();
            loadCutiData();
            
            // Load employees immediately, don't wait for auth
            loadEmployeesFromFirestore();
            
            // Initialize auth after loading data
            initAuth();
        }

        // Event Listeners
        function setupEventListeners() {
            modeToggle.addEventListener('click', toggleMode);
            document.getElementById('addEmployeeBtn').addEventListener('click', openAddEmployeeModal);
            document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
            document.getElementById('closeEmployeeModal').addEventListener('click', closeEmployeeModal);
            document.getElementById('cancelEmployeeModal').addEventListener('click', closeEmployeeModal);
            document.getElementById('loginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('cancelLogin').addEventListener('click', closeLoginModal);
            employeeForm.addEventListener('submit', handleEmployeeSubmit);
            searchInput.addEventListener('input', handleSearch);
            document.getElementById('employeePhoto').addEventListener('change', handlePhotoUpload);
            document.getElementById('scrollToCuti').addEventListener('click', scrollToCutiSection);
            document.getElementById('refreshCutiData').addEventListener('click', loadCutiData);
            document.getElementById('closeNarasiModal').addEventListener('click', closeNarasiModal);
            document.getElementById('cancelNarasiModal').addEventListener('click', closeNarasiModal);
            document.getElementById('narasiForm').addEventListener('submit', handleNarasiSubmit);
            setupPhotoEditorControls();
            
            // Close modals on backdrop click
            detailModal.addEventListener('click', (e) => {
                if (e.target === detailModal) closeDetailModal();
            });
            employeeModal.addEventListener('click', (e) => {
                if (e.target === employeeModal) closeEmployeeModal();
            });
            document.getElementById('loginModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('loginModal')) closeLoginModal();
            });
            document.getElementById('narasiModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('narasiModal')) closeNarasiModal();
            });
        }

        // Handle photo upload
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            const photoError = document.getElementById('photoError');
            const photoPreview = document.getElementById('photoPreview');
            
            photoError.classList.add('hidden');
            
            if (!file) {
                photoPreview.innerHTML = '<span class="text-gray-500 text-xs">Foto</span>';
                document.getElementById('photoEditor').classList.add('hidden');
                return;
            }
            
            // Check file size (700KB = 700 * 1024 bytes)
            if (file.size > 700 * 1024) {
                photoError.textContent = 'Ukuran file terlalu besar! Maksimal 700KB.';
                photoError.classList.remove('hidden');
                e.target.value = '';
                photoPreview.innerHTML = '<span class="text-gray-500 text-xs">Foto</span>';
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                photoError.textContent = 'File harus berupa gambar (JPG, PNG, GIF).';
                photoError.classList.remove('hidden');
                e.target.value = '';
                photoPreview.innerHTML = '<span class="text-gray-500 text-xs">Foto</span>';
                return;
            }
            
            // Load image for editing
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    photoEditorState.originalImage = img;
                    initPhotoEditor();
                    document.getElementById('photoEditor').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Initialize photo editor
        function initPhotoEditor() {
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            const overlay = document.getElementById('cropOverlay');
            
            photoEditorState.canvas = canvas;
            photoEditorState.ctx = ctx;
            
            // Reset state
            photoEditorState.scale = 1;
            photoEditorState.rotation = 0;
            photoEditorState.offsetX = 0;
            photoEditorState.offsetY = 0;
            photoEditorState.cropX = 75;
            photoEditorState.cropY = 75;
            
            // Set up crop overlay dragging
            let isDraggingCrop = false;
            let cropDragStartX = 0;
            let cropDragStartY = 0;
            
            overlay.addEventListener('mousedown', (e) => {
                isDraggingCrop = true;
                const rect = canvas.getBoundingClientRect();
                cropDragStartX = e.clientX - rect.left - photoEditorState.cropX;
                cropDragStartY = e.clientY - rect.top - photoEditorState.cropY;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDraggingCrop) {
                    const rect = canvas.getBoundingClientRect();
                    const newX = e.clientX - rect.left - cropDragStartX;
                    const newY = e.clientY - rect.top - cropDragStartY;
                    
                    // Constrain crop area within canvas
                    photoEditorState.cropX = Math.max(0, Math.min(newX, canvas.width - photoEditorState.cropSize));
                    photoEditorState.cropY = Math.max(0, Math.min(newY, canvas.height - photoEditorState.cropSize));
                    
                    overlay.style.left = photoEditorState.cropX + 'px';
                    overlay.style.top = photoEditorState.cropY + 'px';
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDraggingCrop = false;
            });
            
            // Setup photo editor controls now that elements exist
            setupPhotoEditorEventListeners();
            
            // Initial draw
            drawPhoto();
        }

        // Draw photo on canvas
        function drawPhoto() {
            const { canvas, ctx, originalImage, scale, rotation, offsetX, offsetY } = photoEditorState;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Save context
            ctx.save();
            
            // Move to center for rotation
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(rotation * Math.PI / 180);
            ctx.scale(scale, scale);
            ctx.translate(offsetX, offsetY);
            
            // Calculate image dimensions to fit canvas
            const imgAspect = originalImage.width / originalImage.height;
            const canvasAspect = canvas.width / canvas.height;
            
            let drawWidth, drawHeight;
            if (imgAspect > canvasAspect) {
                drawHeight = canvas.height;
                drawWidth = drawHeight * imgAspect;
            } else {
                drawWidth = canvas.width;
                drawHeight = drawWidth / imgAspect;
            }
            
            // Draw image centered
            ctx.drawImage(originalImage, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
            
            // Restore context
            ctx.restore();
        }

        // Photo editor controls
        function setupPhotoEditorControls() {
            // Canvas dragging for panning - setup later when canvas is available
            // Other controls will be set up when photo editor is initialized
        }

        // Setup photo editor event listeners when editor is shown
        function setupPhotoEditorEventListeners() {
            // Check if elements exist before adding event listeners
            const zoomIn = document.getElementById('zoomIn');
            const zoomOut = document.getElementById('zoomOut');
            const rotateLeft = document.getElementById('rotateLeft');
            const rotateRight = document.getElementById('rotateRight');
            const resetPhoto = document.getElementById('resetPhoto');
            const applyPhotoEditBtn = document.getElementById('applyPhotoEdit');
            const cancelPhotoEditBtn = document.getElementById('cancelPhotoEdit');
            
            if (zoomIn) {
                zoomIn.addEventListener('click', () => {
                    photoEditorState.scale = Math.min(photoEditorState.scale * 1.2, 3);
                    drawPhoto();
                });
            }
            
            if (zoomOut) {
                zoomOut.addEventListener('click', () => {
                    photoEditorState.scale = Math.max(photoEditorState.scale / 1.2, 0.5);
                    drawPhoto();
                });
            }
            
            if (rotateLeft) {
                rotateLeft.addEventListener('click', () => {
                    photoEditorState.rotation -= 90;
                    drawPhoto();
                });
            }
            
            if (rotateRight) {
                rotateRight.addEventListener('click', () => {
                    photoEditorState.rotation += 90;
                    drawPhoto();
                });
            }
            
            if (resetPhoto) {
                resetPhoto.addEventListener('click', () => {
                    photoEditorState.scale = 1;
                    photoEditorState.rotation = 0;
                    photoEditorState.offsetX = 0;
                    photoEditorState.offsetY = 0;
                    drawPhoto();
                });
            }
            
            if (applyPhotoEditBtn) {
                applyPhotoEditBtn.addEventListener('click', applyPhotoEdit);
            }
            
            if (cancelPhotoEditBtn) {
                cancelPhotoEditBtn.addEventListener('click', cancelPhotoEdit);
            }
            
            // Canvas dragging for panning
            const canvas = document.getElementById('photoCanvas');
            if (canvas) {
                let isDragging = false;
                let lastX, lastY;
                
                canvas.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const deltaX = (e.clientX - lastX) / photoEditorState.scale;
                        const deltaY = (e.clientY - lastY) / photoEditorState.scale;
                        
                        photoEditorState.offsetX += deltaX;
                        photoEditorState.offsetY += deltaY;
                        
                        lastX = e.clientX;
                        lastY = e.clientY;
                        
                        drawPhoto();
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }
        }

        // Apply photo edit
        function applyPhotoEdit() {
            const { canvas, cropX, cropY, cropSize } = photoEditorState;
            
            // Create a new canvas for the cropped image
            const cropCanvas = document.createElement('canvas');
            const cropCtx = cropCanvas.getContext('2d');
            cropCanvas.width = cropSize;
            cropCanvas.height = cropSize;
            
            // Get image data from the crop area
            const imageData = photoEditorState.ctx.getImageData(cropX, cropY, cropSize, cropSize);
            cropCtx.putImageData(imageData, 0, 0);
            
            // Convert to data URL
            const croppedDataUrl = cropCanvas.toDataURL('image/jpeg', 0.8);
            
            // Update preview
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = `<img src="${croppedDataUrl}" alt="Preview" class="w-full h-full object-cover rounded-full">`;
            
            // Store the cropped image data
            photoPreview.setAttribute('data-cropped-image', croppedDataUrl);
            
            // Hide editor
            document.getElementById('photoEditor').classList.add('hidden');
        }

        // Cancel photo edit
        function cancelPhotoEdit() {
            document.getElementById('photoEditor').classList.add('hidden');
            document.getElementById('employeePhoto').value = '';
            document.getElementById('photoPreview').innerHTML = '<span class="text-gray-500 text-xs">Foto</span>';
        }

        // Toggle between user and admin mode
        function toggleMode() {
            if (!currentUser) {
                // Show login modal when not logged in
                document.getElementById('loginModal').classList.remove('hidden');
            } else {
                // Logout current user
                auth.signOut().then(() => {
                    console.log('User signed out');
                }).catch((error) => {
                    console.error('Error signing out:', error);
                });
            }
        }

        // Handle admin login
        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const loginError = document.getElementById('loginError');
            
            console.log('🔐 Attempting login with email:', email);
            console.log('🔧 Firebase Auth object:', auth ? 'Available' : 'Not available');
            
            try {
                // Clear previous errors
                loginError.classList.add('hidden');
                
                // Show loading state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '🔄 Logging in...';
                submitBtn.disabled = true;
                
                console.log('📡 Sending login request to Firebase...');
                
                // Sign in with Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('✅ User signed in successfully:', userCredential.user.email);
                console.log('🎯 User UID:', userCredential.user.uid);
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                // The onAuthStateChanged listener will handle the UI updates
            } catch (error) {
                console.error('❌ Login error details:', {
                    code: error.code,
                    message: error.message,
                    email: email
                });
                
                // Reset button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = '🔓 Login';
                submitBtn.disabled = false;
                
                let errorMessage = 'Login gagal. Silakan coba lagi.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = `❌ Email "${email}" tidak terdaftar di sistem.\n\nPastikan email sudah didaftarkan di Firebase Authentication.`;
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '❌ Password salah. Periksa kembali password Anda.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '❌ Format email tidak valid.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '⏰ Terlalu banyak percobaan login. Coba lagi dalam beberapa menit.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = '🌐 Gagal terhubung ke server. Periksa koneksi internet Anda.';
                        break;
                    case 'auth/invalid-credential':
                        errorMessage = '❌ Email atau password tidak valid.';
                        break;
                    default:
                        errorMessage = `❌ Error: ${error.message}`;
                }
                
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
                
                // Show detailed error in console
                console.log('🔍 Detailed error analysis:');
                console.log('   - Email entered:', email);
                console.log('   - Error code:', error.code);
                console.log('   - Error message:', error.message);
                console.log('   - Firebase project:', firebaseConfig.projectId);
            }
        }

        // Close login modal
        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        // Update today's date
        function updateTodayDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('todayDate').textContent = today.toLocaleDateString('id-ID', options);
        }

        // Load cuti data from Google Sheets
        async function loadCutiData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTwN6hYp0m2Q6gQLtuYDN6sWCPBv_u62FgEUvYrWpINdfvZMWmRqizQMF-O9yjx_bFr8nAzG0z2SSlr/pub?gid=574165242&single=true&output=csv');
                const csvText = await response.text();
                
                // Parse CSV data with proper column mapping
                const rows = csvText.split('\n').slice(1); // Skip header row
                cutiData = rows.map(row => {
                    // Handle CSV parsing with proper comma handling inside quotes
                    const cols = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < row.length; i++) {
                        const char = row[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            cols.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    cols.push(current.trim()); // Add the last column
                    
                    // Map columns according to header: Timestamp, Nama Pegawai, Status Pegawai, Jenis Cuti, Tanggal Mulai Cuti, Tanggal Selesai Cuti, Unggah Berkas Persyaratan, Total Hari Cuti
                    if (cols.length >= 8 && cols[1]) {
                        return {
                            timestamp: cols[0]?.replace(/"/g, '').trim(),
                            nama: cols[1]?.replace(/"/g, '').trim(),
                            statusPegawai: cols[2]?.replace(/"/g, '').trim(),
                            jenisCuti: cols[3]?.replace(/"/g, '').trim(),
                            tanggalMulai: cols[4]?.replace(/"/g, '').trim(),
                            tanggalSelesai: cols[5]?.replace(/"/g, '').trim(),
                            berkas: cols[6]?.replace(/"/g, '').trim(),
                            totalHari: cols[7]?.replace(/"/g, '').trim()
                        };
                    }
                    return null;
                }).filter(item => item && item.nama && item.tanggalMulai && item.tanggalSelesai);
                
                console.log('Data cuti berhasil dimuat:', cutiData.length, 'records');
                renderCutiToday();
            } catch (error) {
                console.error('Error loading cuti data:', error);
                document.getElementById('cutiTodayContainer').innerHTML = `
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                        <p class="text-white">❌ Gagal memuat data cuti</p>
                        <p class="text-orange-100 text-sm mt-1">Periksa koneksi internet atau coba refresh</p>
                        <button onclick="loadCutiData()" class="mt-2 bg-white bg-opacity-30 hover:bg-opacity-40 px-3 py-1 rounded text-sm transition-colors">
                            🔄 Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        // Check if date is today
        function isToday(dateString) {
            if (!dateString) return false;
            
            try {
                // Handle different date formats
                let date;
                if (dateString.includes('/')) {
                    // Format: DD/MM/YYYY or MM/DD/YYYY
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        // Assume DD/MM/YYYY format
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } else if (dateString.includes('-')) {
                    // Format: YYYY-MM-DD
                    date = new Date(dateString);
                } else {
                    return false;
                }
                
                const today = new Date();
                return date.getDate() === today.getDate() &&
                       date.getMonth() === today.getMonth() &&
                       date.getFullYear() === today.getFullYear();
            } catch (error) {
                return false;
            }
        }

        // Check if today is between start and end date
        function isTodayInRange(startDate, endDate) {
            if (!startDate || !endDate) return false;
            
            try {
                let start, end;
                
                // Parse start date
                if (startDate.includes('/')) {
                    const parts = startDate.split('/');
                    start = new Date(parts[2], parts[1] - 1, parts[0]);
                } else if (startDate.includes('-')) {
                    start = new Date(startDate);
                } else {
                    return false;
                }
                
                // Parse end date
                if (endDate.includes('/')) {
                    const parts = endDate.split('/');
                    end = new Date(parts[2], parts[1] - 1, parts[0]);
                } else if (endDate.includes('-')) {
                    end = new Date(endDate);
                } else {
                    return false;
                }
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);
                
                return today >= start && today <= end;
            } catch (error) {
                return false;
            }
        }

        // Render employees on leave today
        function renderCutiToday() {
            const container = document.getElementById('cutiTodayContainer');
            
            // Filter employees who are on leave today
            const employeesOnLeaveToday = cutiData.filter(cuti => 
                isTodayInRange(cuti.tanggalMulai, cuti.tanggalSelesai)
            );
            
            if (employeesOnLeaveToday.length === 0) {
                container.innerHTML = `
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 text-center">
                        <p class="text-white font-medium">✅ Tidak ada pegawai yang cuti hari ini</p>
                        <p class="text-orange-100 text-sm mt-1">Semua pegawai hadir bekerja</p>
                        ${cutiData.length > 0 ? `<p class="text-orange-200 text-xs mt-2">Total ${cutiData.length} data cuti tersedia</p>` : ''}
                    </div>
                `;
                return;
            }
            
            container.innerHTML = employeesOnLeaveToday.map(cuti => `
                <div class="bg-white bg-opacity-20 rounded-lg p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-30 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">${cuti.nama.charAt(0).toUpperCase()}</span>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold">${cuti.nama}</h3>
                            <p class="text-orange-100 text-sm">${cuti.statusPegawai}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-white font-medium">${cuti.jenisCuti}</p>
                        <p class="text-orange-100 text-sm">${cuti.tanggalMulai} - ${cuti.tanggalSelesai}</p>
                        <p class="text-orange-200 text-xs mt-1">${cuti.totalHari} hari</p>
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStatistics() {
            // Update total employees
            document.getElementById('totalEmployees').textContent = employees.length;
            
            // Calculate most used leave type
            const leaveTypes = {
                'Tahunan': 0,
                'Besar': 0,
                'Alasan Penting': 0,
                'Sakit': 0,
                'Melahirkan': 0,
                'Diluar Tanggungan': 0
            };
            
            employees.forEach(employee => {
                leaveTypes['Tahunan'] += employee.cutiTahunan;
                leaveTypes['Besar'] += employee.cutiBesar;
                leaveTypes['Alasan Penting'] += employee.cutiAlasanPenting;
                leaveTypes['Sakit'] += employee.cutiSakit;
                leaveTypes['Melahirkan'] += employee.cutiMelahirkan;
                leaveTypes['Diluar Tanggungan'] += employee.cutiDiluarTanggungan;
            });
            
            // Find most used leave type
            let mostUsed = { type: '-', count: 0 };
            for (const [type, count] of Object.entries(leaveTypes)) {
                if (count > mostUsed.count) {
                    mostUsed = { type, count };
                }
            }
            
            document.getElementById('mostUsedLeave').textContent = 
                mostUsed.count > 0 ? `${mostUsed.type} (${mostUsed.count})` : '-';
        }

        // Generate avatar with initials or photo
        function generateAvatar(name, photo = null) {
            if (photo) {
                return `<div class="w-16 h-16 rounded-full overflow-hidden border-2 border-gray-200">
                    <img src="${photo}" alt="${name}" class="w-full h-full object-cover">
                </div>`;
            }
            
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-red-500'];
            const colorClass = colors[name.length % colors.length];
            
            return `<div class="${colorClass} w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-xl">${initials}</div>`;
        }

        // Calculate total leave days
        function calculateTotalLeave(employee) {
            return employee.cutiTahunan + employee.cutiBesar + employee.cutiAlasanPenting + 
                   employee.cutiSakit + employee.cutiMelahirkan + employee.cutiDiluarTanggungan;
        }

        // Render employee cards
        function renderEmployees(filteredEmployees = null) {
            const employeesToRender = filteredEmployees || employees;
            const loadingState = document.getElementById('loadingState');
            
            // Hide loading state
            loadingState.classList.add('hidden');
            
            // Update statistics
            updateStatistics();
            
            if (employeesToRender.length === 0) {
                employeeGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            employeeGrid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            employeeGrid.innerHTML = employeesToRender.map(employee => {
                const totalLeave = calculateTotalLeave(employee);
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover cursor-pointer relative" onclick="openEmployeeDetail('${employee.id}')"
                        ${isAdminMode ? `
                            <button onclick="event.stopPropagation(); deleteEmployee('${employee.id}')" 
                                    class="absolute top-3 right-3 text-red-500 hover:text-red-700 text-xl font-bold">×</button>
                            <button onclick="event.stopPropagation(); editEmployee('${employee.id}')" 
                                    class="absolute top-3 right-8 text-blue-500 hover:text-blue-700 text-lg">✏️</button>
                        ` : ''}
                        
                        <div class="flex flex-col items-center text-center">
                            ${generateAvatar(employee.name, employee.photo)}
                            <h3 class="mt-4 text-lg font-bold text-gray-800">${employee.name}</h3>
                            <p class="text-sm text-gray-600 mb-2">${employee.position}</p>
                            <p class="text-xs text-gray-500 mb-4">NIP: ${employee.nip}</p>
                            
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                <div class="bg-red-600 h-2 rounded-full" style="width: ${Math.min((totalLeave / 30) * 100, 100)}%"></div>
                            </div>
                            <p class="text-sm font-medium text-gray-700">
                                Total Cuti: <span class="text-red-600 font-bold">${totalLeave} hari</span>
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open employee detail modal
        function openEmployeeDetail(employeeId) {
            console.log('Opening detail for employee ID:', employeeId);
            const employee = employees.find(emp => emp.id == employeeId);
            if (!employee) {
                console.error('Employee not found:', employeeId);
                return;
            }

            const totalLeave = calculateTotalLeave(employee);
            
            document.getElementById('detailContent').innerHTML = `
                <div class="flex items-center space-x-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    ${generateAvatar(employee.name, employee.photo)}
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${employee.name}</h3>
                        <p class="text-gray-600">${employee.position}</p>
                        <p class="text-sm text-gray-500">NIP: ${employee.nip}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg ${isAdminMode ? 'cursor-pointer hover:bg-blue-100' : ''} transition-colors" ${isAdminMode ? `onclick="openNarasiModal('${employee.id}', 'cutiTahunan', 'Cuti Tahunan')"` : ''}>
                        <h4 class="font-semibold text-blue-800 mb-2">📅 Cuti Tahunan Terpakai</h4>
                        <p class="text-2xl font-bold text-blue-600">${employee.cutiTahunan} hari</p>
                        ${employee.narasi?.cutiTahunan ? `<p class="text-sm text-blue-700 mt-2 italic">"${employee.narasi.cutiTahunan}"</p>` : ''}
                        ${isAdminMode ? '<p class="text-xs text-blue-600 mt-1">👆 Klik untuk edit narasi</p>' : ''}
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg ${isAdminMode ? 'cursor-pointer hover:bg-green-100' : ''} transition-colors" ${isAdminMode ? `onclick="openNarasiModal('${employee.id}', 'cutiBesar', 'Cuti Besar')"` : ''}>
                        <h4 class="font-semibold text-green-800 mb-2">🏖️ Cuti Besar Terpakai</h4>
                        <p class="text-2xl font-bold text-green-600">${employee.cutiBesar} hari</p>
                        ${employee.narasi?.cutiBesar ? `<p class="text-sm text-green-700 mt-2 italic">"${employee.narasi.cutiBesar}"</p>` : ''}
                        ${isAdminMode ? '<p class="text-xs text-green-600 mt-1">👆 Klik untuk edit narasi</p>' : ''}
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg ${isAdminMode ? 'cursor-pointer hover:bg-yellow-100' : ''} transition-colors" ${isAdminMode ? `onclick="openNarasiModal('${employee.id}', 'cutiAlasanPenting', 'Cuti Alasan Penting')"` : ''}>
                        <h4 class="font-semibold text-yellow-800 mb-2">⚠️ Cuti Alasan Penting Terpakai</h4>
                        <p class="text-2xl font-bold text-yellow-600">${employee.cutiAlasanPenting} hari</p>
                        ${employee.narasi?.cutiAlasanPenting ? `<p class="text-sm text-yellow-700 mt-2 italic">"${employee.narasi.cutiAlasanPenting}"</p>` : ''}
                        ${isAdminMode ? '<p class="text-xs text-yellow-600 mt-1">👆 Klik untuk edit narasi</p>' : ''}
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg ${isAdminMode ? 'cursor-pointer hover:bg-red-100' : ''} transition-colors" ${isAdminMode ? `onclick="openNarasiModal('${employee.id}', 'cutiSakit', 'Cuti Sakit')"` : ''}>
                        <h4 class="font-semibold text-red-800 mb-2">🏥 Cuti Sakit Terpakai</h4>
                        <p class="text-2xl font-bold text-red-600">${employee.cutiSakit} hari</p>
                        ${employee.narasi?.cutiSakit ? `<p class="text-sm text-red-700 mt-2 italic">"${employee.narasi.cutiSakit}"</p>` : ''}
                        ${isAdminMode ? '<p class="text-xs text-red-600 mt-1">👆 Klik untuk edit narasi</p>' : ''}
                    </div>
                    <div class="bg-pink-50 p-4 rounded-lg ${isAdminMode ? 'cursor-pointer hover:bg-pink-100' : ''} transition-colors" ${isAdminMode ? `onclick="openNarasiModal('${employee.id}', 'cutiMelahirkan', 'Cuti Melahirkan')"` : ''}>
                        <h4 class="font-semibold text-pink-800 mb-2">👶 Cuti Melahirkan Terpakai</h4>
                        <p class="text-2xl font-bold text-pink-600">${employee.cutiMelahirkan} hari</p>
                        ${employee.narasi?.cutiMelahirkan ? `<p class="text-sm text-pink-700 mt-2 italic">"${employee.narasi.cutiMelahirkan}"</p>` : ''}
                        ${isAdminMode ? '<p class="text-xs text-pink-600 mt-1">👆 Klik untuk edit narasi</p>' : ''}
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg ${isAdminMode ? 'cursor-pointer hover:bg-gray-100' : ''} transition-colors" ${isAdminMode ? `onclick="openNarasiModal('${employee.id}', 'cutiDiluarTanggungan', 'Cuti Diluar Tanggungan Negara')"` : ''}>
                        <h4 class="font-semibold text-gray-800 mb-2">🏃 Cuti Diluar Tanggungan Negara Terpakai</h4>
                        <p class="text-2xl font-bold text-gray-600">${employee.cutiDiluarTanggungan} hari</p>
                        ${employee.narasi?.cutiDiluarTanggungan ? `<p class="text-sm text-gray-700 mt-2 italic">"${employee.narasi.cutiDiluarTanggungan}"</p>` : ''}
                        ${isAdminMode ? '<p class="text-xs text-gray-600 mt-1">👆 Klik untuk edit narasi</p>' : ''}
                    </div>
                </div>
                
                <div class="bg-indigo-50 p-4 rounded-lg text-center ${isAdminMode ? 'cursor-pointer hover:bg-indigo-100' : ''} transition-colors" ${isAdminMode ? `onclick="openNarasiModal('${employee.id}', 'totalCuti', 'Total Cuti')"` : ''}>
                    <h4 class="font-semibold text-indigo-800 mb-2">📊 Total Cuti Terpakai</h4>
                    <p class="text-3xl font-bold text-indigo-600">${totalLeave} hari</p>
                    ${employee.narasi?.totalCuti ? `<p class="text-sm text-indigo-700 mt-2 italic">"${employee.narasi.totalCuti}"</p>` : ''}
                    ${isAdminMode ? '<p class="text-xs text-indigo-600 mt-1">👆 Klik untuk edit narasi</p>' : ''}
                </div>
            `;
            
            detailModal.classList.remove('hidden');
        }

        // Close detail modal
        function closeDetailModal() {
            detailModal.classList.add('hidden');
        }

        // Scroll to cuti section
        function scrollToCutiSection() {
            const cutiSection = document.getElementById('cutiSection');
            const modal = document.querySelector('#employeeModal .p-6');
            
            // Scroll within the modal container
            cutiSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
            
            // Alternative scroll method for modal
            setTimeout(() => {
                modal.scrollTo({
                    top: cutiSection.offsetTop - 100,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Open add employee modal
        function openAddEmployeeModal() {
            editingEmployeeId = null;
            document.getElementById('modalTitle').textContent = 'Tambah Pegawai Baru';
            employeeForm.reset();
            document.getElementById('photoPreview').innerHTML = '<span class="text-gray-500 text-xs">Foto</span>';
            document.getElementById('photoPreview').removeAttribute('data-cropped-image');
            document.getElementById('photoError').classList.add('hidden');
            document.getElementById('photoEditor').classList.add('hidden');
            employeeModal.classList.remove('hidden');
        }

        // Edit employee
        function editEmployee(employeeId) {
            console.log('Editing employee ID:', employeeId);
            const employee = employees.find(emp => emp.id == employeeId);
            if (!employee) {
                console.error('Employee not found for edit:', employeeId);
                return;
            }

            editingEmployeeId = employeeId;
            document.getElementById('modalTitle').textContent = 'Edit Data Pegawai';
            
            document.getElementById('employeeName').value = employee.name;
            document.getElementById('employeeNip').value = employee.nip;
            document.getElementById('employeePosition').value = employee.position;
            document.getElementById('cutiTahunan').value = employee.cutiTahunan;
            document.getElementById('cutiBesar').value = employee.cutiBesar;
            document.getElementById('cutiAlasanPenting').value = employee.cutiAlasanPenting;
            document.getElementById('cutiSakit').value = employee.cutiSakit;
            document.getElementById('cutiMelahirkan').value = employee.cutiMelahirkan;
            document.getElementById('cutiDiluarTanggungan').value = employee.cutiDiluarTanggungan;
            
            // Set photo preview
            const photoPreview = document.getElementById('photoPreview');
            if (employee.photo) {
                photoPreview.innerHTML = `<img src="${employee.photo}" alt="Preview" class="w-full h-full object-cover rounded-full">`;
                photoPreview.setAttribute('data-cropped-image', employee.photo);
            } else {
                photoPreview.innerHTML = '<span class="text-gray-500 text-xs">Foto</span>';
                photoPreview.removeAttribute('data-cropped-image');
            }
            
            document.getElementById('photoError').classList.add('hidden');
            document.getElementById('photoEditor').classList.add('hidden');
            employeeModal.classList.remove('hidden');
        }

        // Close employee modal
        function closeEmployeeModal() {
            employeeModal.classList.add('hidden');
            editingEmployeeId = null;
            document.getElementById('photoEditor').classList.add('hidden');
        }

        // Handle employee form submission
        async function handleEmployeeSubmit(e) {
            e.preventDefault();
            
            if (!currentUser || !isAdminMode) {
                alert('Anda harus login sebagai admin untuk menambah/edit pegawai.');
                return;
            }
            
            // Get photo data
            const photoFile = document.getElementById('employeePhoto').files[0];
            
            const processFormData = async (photoDataUrl = null) => {
                const formData = {
                    name: document.getElementById('employeeName').value,
                    nip: document.getElementById('employeeNip').value,
                    position: document.getElementById('employeePosition').value,
                    photo: photoDataUrl,
                    cutiTahunan: parseInt(document.getElementById('cutiTahunan').value) || 0,
                    cutiBesar: parseInt(document.getElementById('cutiBesar').value) || 0,
                    cutiAlasanPenting: parseInt(document.getElementById('cutiAlasanPenting').value) || 0,
                    cutiSakit: parseInt(document.getElementById('cutiSakit').value) || 0,
                    cutiMelahirkan: parseInt(document.getElementById('cutiMelahirkan').value) || 0,
                    cutiDiluarTanggungan: parseInt(document.getElementById('cutiDiluarTanggungan').value) || 0,
                    narasi: {
                        cutiTahunan: "",
                        cutiBesar: "",
                        cutiAlasanPenting: "",
                        cutiSakit: "",
                        cutiMelahirkan: "",
                        cutiDiluarTanggungan: "",
                        totalCuti: ""
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (editingEmployeeId) {
                    // Update existing employee
                    const existingEmployee = employees.find(emp => emp.id === editingEmployeeId);
                    if (existingEmployee) {
                        // Keep existing photo if no new photo uploaded
                        if (!photoDataUrl && existingEmployee.photo) {
                            formData.photo = existingEmployee.photo;
                        }
                        // Keep existing narasi
                        if (existingEmployee.narasi) {
                            formData.narasi = existingEmployee.narasi;
                        }
                        formData.id = editingEmployeeId;
                        formData.createdAt = existingEmployee.createdAt; // Keep original creation date
                    }
                }

                await saveEmployeeToFirestore(formData);
                closeEmployeeModal();
            };
            
            // Check if we have a cropped image
            const photoPreview = document.getElementById('photoPreview');
            const croppedImage = photoPreview.getAttribute('data-cropped-image');
            
            if (croppedImage) {
                // Use cropped image
                processFormData(croppedImage);
            } else if (photoFile) {
                // Use original uploaded file
                const reader = new FileReader();
                reader.onload = function(e) {
                    processFormData(e.target.result);
                };
                reader.readAsDataURL(photoFile);
            } else {
                processFormData();
            }
        }

        // Delete employee
        async function deleteEmployee(employeeId) {
            console.log('Deleting employee ID:', employeeId);
            
            if (!currentUser || !isAdminMode) {
                alert('Anda harus login sebagai admin untuk menghapus pegawai.');
                return;
            }
            
            const employee = employees.find(emp => emp.id == employeeId);
            if (!employee) {
                console.error('Employee not found for delete:', employeeId);
                alert('Data pegawai tidak ditemukan.');
                return;
            }
            
            // Show confirmation with employee name
            const confirmMessage = `Apakah Anda yakin ingin menghapus data pegawai:\n\n"${employee.name}"\nNIP: ${employee.nip}\nJabatan: ${employee.position}\n\nData yang dihapus tidak dapat dikembalikan!`;
            
            if (confirm(confirmMessage)) {
                try {
                    console.log('Attempting to delete employee from Firestore...');
                    await deleteEmployeeFromFirestore(employeeId);
                    console.log('Employee deleted successfully');
                    
                    // Show success message
                    alert(`Data pegawai "${employee.name}" berhasil dihapus.`);
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    alert('Gagal menghapus data pegawai. Silakan coba lagi.');
                }
            }
        }

        // Handle search
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm === '') {
                renderEmployees();
                return;
            }

            const filteredEmployees = employees.filter(employee => 
                employee.name.toLowerCase().includes(searchTerm) ||
                employee.nip.includes(searchTerm) ||
                employee.position.toLowerCase().includes(searchTerm)
            );
            
            renderEmployees(filteredEmployees);
        }

        // Open narasi modal
        function openNarasiModal(employeeId, narasiType, narasiTitle) {
            if (!isAdminMode) return; // Only admin can edit narasi
            
            const employee = employees.find(emp => emp.id == employeeId);
            if (!employee) {
                console.error('Employee not found for narasi:', employeeId);
                return;
            }
            
            currentNarasiEmployee = employeeId;
            currentNarasiType = narasiType;
            
            document.getElementById('narasiModalTitle').textContent = `Edit Narasi ${narasiTitle}`;
            document.getElementById('narasiLabel').textContent = `Narasi untuk ${narasiTitle}`;
            
            // Set current narasi text
            const currentNarasi = employee.narasi?.[narasiType] || '';
            document.getElementById('narasiText').value = currentNarasi;
            
            document.getElementById('narasiModal').classList.remove('hidden');
        }

        // Close narasi modal
        function closeNarasiModal() {
            document.getElementById('narasiModal').classList.add('hidden');
            document.getElementById('narasiForm').reset();
            currentNarasiEmployee = null;
            currentNarasiType = null;
        }

        // Handle narasi form submission
        async function handleNarasiSubmit(e) {
            e.preventDefault();
            
            if (!currentUser || !isAdminMode) {
                alert('Anda harus login sebagai admin untuk mengedit narasi.');
                return;
            }
            
            if (!currentNarasiEmployee || !currentNarasiType) return;
            
            const narasiText = document.getElementById('narasiText').value.trim();
            const employee = employees.find(emp => emp.id == currentNarasiEmployee);
            
            if (employee) {
                // Initialize narasi object if it doesn't exist
                if (!employee.narasi) {
                    employee.narasi = {
                        cutiTahunan: "",
                        cutiBesar: "",
                        cutiAlasanPenting: "",
                        cutiSakit: "",
                        cutiMelahirkan: "",
                        cutiDiluarTanggungan: "",
                        totalCuti: ""
                    };
                }
                
                // Update the narasi
                employee.narasi[currentNarasiType] = narasiText;
                
                // Save to Firestore
                try {
                    await db.collection('employees').doc(currentNarasiEmployee).update({
                        narasi: employee.narasi,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Refresh the detail modal if it's open
                    if (!detailModal.classList.contains('hidden')) {
                        openEmployeeDetail(currentNarasiEmployee);
                    }
                } catch (error) {
                    console.error('Error updating narasi:', error);
                    alert('Gagal menyimpan narasi. Silakan coba lagi.');
                }
            }
            
            closeNarasiModal();
        }

        // Debug function to check Firebase status
        async function checkFirebaseStatus() {
            console.log('🔍 === FIREBASE STATUS CHECK ===');
            
            try {
                // Check Firebase initialization
                console.log('📊 Firebase apps:', firebase.apps.length);
                console.log('🔧 Firebase config:', firebaseConfig);
                
                // Check Auth
                console.log('🔐 Auth object:', auth ? 'Available' : 'Not available');
                console.log('👤 Current user:', currentUser ? currentUser.email : 'Not logged in');
                
                // Check Firestore
                console.log('💾 Firestore object:', db ? 'Available' : 'Not available');
                
                // Test basic Firestore operation
                console.log('🧪 Testing basic Firestore read...');
                const testDoc = await db.collection('test').doc('connection').get();
                console.log('✅ Firestore read test successful');
                
                // Check employees collection
                console.log('👥 Testing employees collection...');
                const employeesSnapshot = await db.collection('employees').get();
                console.log('📊 Employees collection size:', employeesSnapshot.size);
                
                if (employeesSnapshot.size > 0) {
                    console.log('📋 Sample employee documents:');
                    employeesSnapshot.docs.slice(0, 3).forEach((doc, index) => {
                        console.log(`   ${index + 1}. ID: ${doc.id}, Data:`, doc.data());
                    });
                }
                
                alert(`✅ Firebase Status Check Complete!\n\n` +
                      `🔧 Firebase: ${firebase.apps.length > 0 ? 'Initialized' : 'Not initialized'}\n` +
                      `🔐 Auth: ${auth ? 'Available' : 'Not available'}\n` +
                      `💾 Firestore: ${db ? 'Available' : 'Not available'}\n` +
                      `👥 Employees: ${employeesSnapshot.size} documents found\n\n` +
                      `Check console for detailed logs.`);
                
            } catch (error) {
                console.error('❌ Firebase status check failed:', error);
                alert(`❌ Firebase Status Check Failed!\n\nError: ${error.message}\n\nCheck console for details.`);
            }
        }

        // Initialize the application
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a5b2e46002fd89',t:'MTc1OTc1OTM3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
